define(function(){function t(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function n(t,n){return Array(n+1).join(t)}function a(){var t=arguments[0],n=a.cache;return n[t]&&n.hasOwnProperty(t)||(n[t]=a.parse(t)),a.format.call(null,n[t],arguments)}var e={not_string:/[^s]/,number:/[def]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};return a.format=function(i,s){var o,r,d,l,c,f,p,u=1,h=i.length,_="",m=[],v=!0,T="";for(r=0;h>r;r++)if(_=t(i[r]),"string"===_)m[m.length]=i[r];else if("array"===_){if(l=i[r],l[2])for(o=s[u],d=0;d<l[2].length;d++){if(!o.hasOwnProperty(l[2][d]))throw new Error(a("[sprintf] property '%s' does not exist",l[2][d]));o=o[l[2][d]]}else o=l[1]?s[l[1]]:s[u++];if("function"==t(o)&&(o=o()),e.not_string.test(l[8])&&"number"!=t(o)&&isNaN(o))throw new TypeError(a("[sprintf] expecting number but found %s",t(o)));switch(e.number.test(l[8])&&(v=o>=0),l[8]){case"b":o=o.toString(2);break;case"c":o=String.fromCharCode(o);break;case"d":o=parseInt(o,10);break;case"e":o=l[7]?o.toExponential(l[7]):o.toExponential();break;case"f":o=l[7]?parseFloat(o).toFixed(l[7]):parseFloat(o);break;case"o":o=o.toString(8);break;case"s":o=(o=String(o))&&l[7]?o.substring(0,l[7]):o;break;case"u":o>>>=0;break;case"x":o=o.toString(16);break;case"X":o=o.toString(16).toUpperCase()}(!v||e.number.test(l[8])&&l[3])&&(T=v?"+":"-",o=o.toString().replace(e.sign,"")),f=l[4]?"0"==l[4]?"0":l[4].charAt(1):" ",p=l[6]-(T+o).length,c=l[6]?n(f,p):"",m[m.length]=l[5]?T+o+c:0==f?T+c+o:c+T+o}return m.join("")},a.cache={},a.parse=function(t){for(var n=t,a=[],i=[],s=0;n;){if(null!==(a=e.text.exec(n)))i[i.length]=a[0];else if(null!==(a=e.modulo.exec(n)))i[i.length]="%";else{if(null===(a=e.placeholder.exec(n)))throw new SyntaxError("[sprintf] unexpected placeholder");if(a[2]){s|=1;var o=[],r=a[2],d=[];if(null===(d=e.key.exec(r)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(o[o.length]=d[1];""!==(r=r.substring(d[0].length));)if(null!==(d=e.key_access.exec(r)))o[o.length]=d[1];else{if(null===(d=e.index_access.exec(r)))throw new SyntaxError("[sprintf] failed to parse named argument key");o[o.length]=d[1]}a[2]=o}else s|=2;if(3===s)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");i[i.length]=a}n=n.substring(a[0].length)}return i},a});
