define(["jquery","etdsolutions/text"],function(t,a){return{$form:null,$filtersContainer:null,$filtersInputs:null,$modal:null,options:{ajaxURI:null,token:null,data:{},itemView:null,listView:null,modalTemplate:'<div class="modal fade" id="form-modal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">'+a._("APP_GLOBAL_CLOSE")+'</span></button><h4 class="modal-title"></h4></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">'+a._("APP_GLOBAL_CLOSE")+'</button><button type="button" class="btn btn-primary">'+a._("APP_GLOBAL_OK")+"</button></div></div></div></div>",modalRemoteTemplate:'<div class="modal fade" id="form-modal"><div class="modal-dialog"><div class="modal-content"></div></div></div>',modal:{backdrop:!0,keyboard:!0,show:!1,remote:!1},selectors:{checkboxes:".list-col-cb input:enabled",itemButtons:".btn-list:not(.btn-list-custom)",limitInput:"#limit",checkAll:'input[name="checkAll"]',taskInput:'input[name="task"]',orderingBtn:"th .list-ordering",orderingInput:'input[name="list_ordering"]',directionInput:'input[name="list_direction"]',sortableContainer:"table",sortableHandle:".sortable-handle.active",filterInputs:'select, input[type="checkbox"], input[type="radio"]'}},ordering:{activeOrdering:"",activeDirection:""},init:function(a,n){return this.$form=t(a),t.extend(!0,this.options,n),this.ordering.activeOrdering=this.$form.find(this.options.selectors.orderingInput).val(),this.ordering.activeDirection=this.$form.find(this.options.selectors.directionInput).val(),this.bind().makeSortable(),this},bind:function(){return this.$form.find(this.options.selectors.itemButtons).on("click",t.proxy(this.onListBtnClick,this)),t(this.options.selectors.limitInput).on("change",t.proxy(this.onLimitChange,this)),this.$form.find(this.options.selectors.checkAll).on("change",t.proxy(this.onCheckAllChange,this)),this.$form.find(this.options.selectors.orderingBtn).on("click",t.proxy(this.onOrderingColumnClick,this)),this},addToolbarFilters:function(a){return this.$filtersContainer=t(a),this.$filtersInputs=this.$filtersContainer.find(this.options.selectors.filterInputs),this.$filtersInputs.on("change",t.proxy(this.onFilterChange,this)),this},makeSortable:function(){return this.$form.hasClass("form-sortable")&&this.$form.find(this.options.selectors.sortableContainer).tableDnD({onDragClass:"dragging",dragHandle:this.options.selectors.sortableHandle,onDragStart:t.proxy(this.onSortableDragStart,this),onDrop:t.proxy(this.onSortableDrop,this)}),this},makeContentEditable:function(a,n){var i=t(a),e=this;return i.attr("contenteditable","true"),i.data("last-value",i.text()),i.on("blur",function(){if(i.data("last-value")!=i.text()){var t={task:"updateField",name:n,value:i.text()};e.postAjax(t,function(){i.data("last-value",i.text())},function(t){alert(t.message)}),console.log(t)}}),this},prepareEditRow:function(a){var n=this,i=t(a),e=i.find(".inline-edit-input");return i.find(".inline-edit-btn").on("click",function(t){t.preventDefault(),e.data("prev-value",e.val()),i.addClass("editing")}),i.find(".inline-cancel-btn").on("click",function(t){t.preventDefault(),e.val(e.data("prev-value")),i.removeClass("editing")}),i.find(".inline-save-btn").on("click",function(t){t.preventDefault();var a=e.val(),s="";switch(e.prop("tagName").toLowerCase()){case"select":s=e.find('option[value="'+a+'"]').text();break;default:s=a}var o={task:"updateField",name:e.attr("name"),value:a};n.postAjax(o,function(t){i.find(".caption").html(s),i.removeClass("editing")},function(t){e.val(e.data("prev-value")),i.removeClass("editing")})}),this},postAjax:function(a,n,i){return a=t.extend(this.options.data,a),a[this.options.token]="1",t.post(this.options.ajaxURI,a,function(t){t.error&&i?i(t):n&&n(t)}),this},setAjaxURI:function(t){return this.options.ajaxURI=t,this},setAdditionnalData:function(t){return this.options.data=t,this},addHiddenField:function(a,n){var i=this.$form.find('input[name="'+a+'"]');return i.length?i.attr("type","hidden"):(i=t('<input type="hidden" name="'+a+'" value="">'),this.$form.append(i)),i.val(n),this},addSelectTask:function(n,i,e,s){var o=this;return t("#"+n).on("click",function(t){if(t.preventDefault(),o.$form.find(o.options.selectors.checkboxes+":checked").length>0){if(e&&!confirm(s))return this;o.submitTask(i,o.options.itemView)}else alert(a._("APP_ERROR_NO_ITEM_SELECTED"))}),this},addSubmitTask:function(a,n,i,e,s){var o=this;return t("#"+a).on("click",function(t){return t.preventDefault(),e&&!confirm(s)?this:void o.submitTask(n,i)}),this},addValidationTask:function(a,n,i){var e=this;return t("#"+a).on("click",function(t){t.preventDefault(),e.validate()&&e.submitTask(n,i)}),this},submitTask:function(t,a){return a&&this.$form.attr("action","/"+a),this.$form.find(this.options.selectors.taskInput).val(t),this.$form.submit(),this},selectCheckboxes:function(a){var n=this;return"array"!=t.type(a)&&(a=[a]),this.$form.find(this.options.selectors.checkboxes).prop("checked",!1),t.each(a,function(){n.$form.find(n.options.selectors.checkboxes+'[value="'+this+'"]').prop("checked",!0)}),this},validate:function(){return!0},prepareModal:function(a,n,i,e){return i=i||!1,e=t.extend({},this.options.modal,e),i&&this.$modal&&this.$modal.length&&this.$modal.remove(),this.$modal||(this.$modal=t(e.remote?this.options.modalRemoteTemplate:this.options.modalTemplate),t(document.body).append(this.$modal)),this.$modal.find(".modal-title").html(a),this.$modal.find(".modal-body").html(n),this.$modal.modal(e),this},doModal:function(t){return this.$modal&&this.$modal.modal(t),this},showModal:function(){return this.doModal("show")},hideModal:function(){return this.doModal("hide")},onListBtnClick:function(a){a.preventDefault();var n=t(a.delegateTarget),i=n.attr("href").split("/").splice(1);if(n.hasClass("btn-list-modal")){var e=this.options.ajaxURI+"/"+i[1]+"/"+i[2];return 4==i.length&&(e+="/"+i[3]),this.prepareModal("","",!0,{remote:e}),this.showModal(),this}return this.$form.find(this.options.selectors.checkboxes).prop("checked",!1),this.$form.find(this.options.selectors.checkboxes+'[value="'+i.pop()+'"]').prop("checked",!0),this.$form.find(this.options.selectors.taskInput).val(i.pop()),this.$form.attr("action","/"+i.join("/")),this.$form.submit(),this},onLimitChange:function(t){return t.preventDefault(),this.$form.attr("action","/"+this.options.listView),this.$form.submit(),this},onCheckAllChange:function(){return this.$form.find(this.options.selectors.checkboxes).prop("checked",t(this.options.selectors.checkAll).prop("checked")),this},onOrderingColumnClick:function(a){a.preventDefault();var n=t(a.delegateTarget).data("order"),i=t(a.delegateTarget).data("direction");return(this.ordering.activeDirection!=i||this.ordering.activeOrdering!=n)&&(this.ordering.activeOrdering=n,this.ordering.activeDirection=i,this.$form.find(this.options.selectors.orderingInput).val(n),this.$form.find(this.options.selectors.directionInput).val(i),this.$form.attr("action","/"+this.options.listView),this.$form.submit()),this},onSortableDragStart:function(a,n){var i=t(n).parents("tr");t(a).find("tbody > tr[data-sortable-group-id != "+i.data("sortable-group-id")+"]").addClass("nodrop")},onSortableDrop:function(a,n,i){var e=t(n),s=t(a).find('tbody > tr[data-parents*=" '+e.data("item-id")+'"]');s.length&&e.after(s),t(a).find("tbody > tr").removeClass("nodrop");var o=t("tr[data-sortable-group-id = "+e.data("sortable-group-id")+"]"),r=o.length;if(r>1){var d=[],l=[];o.find(this.options.selectors.checkboxes).each(function(a){d.push(t(this).val()),l.push(a)});var c={task:"saveOrder",ids:d,order:l};c[this.options.token]="1",t.post(this.options.ajaxURI,c).done(function(t){console.log("done",t)}).fail(function(t){console.log("fail",t)}).always(function(t){console.log("always",t)})}},onFilterChange:function(a){this.$form.find('[name^="filter"]').remove(),this.$filtersInputs.each(t.proxy(function(a,n){var i=t(n),e=t('<input type="hidden" name="'+i.attr("name")+'" value="'+i.val()+'">');this.$form.append(e)},this)),this.$form.attr("action","/"+this.options.listView),this.$form.submit()}}});
